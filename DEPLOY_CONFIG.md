# 多服务器部署配置说明

这个配置支持将构建的网站并行部署到多个服务器上。使用简化的配置方式，多个服务器IP用 `|` 分割。

## 配置步骤

### 1. 在 GitHub Repository 中配置 Secrets

只需要配置以下 secrets：

- `SERVER_HOSTS`: 所有服务器的IP地址，用 `|` 分割
  - 示例: `"192.168.1.10|192.168.1.11|192.168.1.12"`
- `SERVER_USER`: SSH 用户名 (所有服务器使用相同的用户名)
- `SERVER_PORT`: SSH 端口 (所有服务器使用相同的端口)
- `SSH_PRIVATE_KEY`: SSH 私钥 (用于所有服务器)
- `KNOWN_HOSTS`: SSH known_hosts 内容 (可选，如果不配置会自动扫描)

### 2. 在 GitHub Repository 中配置 Variables

只需要配置以下 variables：

- `SERVER_DIR`: 服务器上的部署目录路径 (所有服务器使用相同的路径)
- `KEEP_RELEASES`: 保留的历史版本数量 (可选，默认5)

### 3. 添加更多服务器

要添加更多服务器，只需要：

1. 在 `SERVER_HOSTS` 中添加新的IP地址（用 `|` 分割）
2. 确保新服务器的SSH配置与现有服务器一致

例如，要添加一个新服务器 `192.168.1.13`：

```
SERVER_HOSTS: "192.168.1.10|192.168.1.11|192.168.1.12|192.168.1.13"
```

## 部署目录结构

在每个服务器上，部署目录结构如下：

```
/var/www/mysite/  (SERVER_DIR)
├── releases/
│   ├── release-20240320-143052-abc123/
│   ├── release-20240320-144123-def456/
│   └── release-20240320-145234-ghi789/
└── current -> releases/release-20240320-145234-ghi789/
```

- `releases/` 目录包含所有历史版本
- `current` 是指向当前版本的符号链接
- 旧版本会自动清理，保留指定数量的版本

## 配置示例

假设您有3台服务器需要部署：

**Secrets 配置：**
```
SERVER_HOSTS: "10.0.1.100|10.0.1.101|10.0.1.102"
SERVER_USER: "deploy"
SERVER_PORT: "22"
SSH_PRIVATE_KEY: "-----BEGIN OPENSSH PRIVATE KEY-----
... (您的私钥内容) ...
-----END OPENSSH PRIVATE KEY-----"
```

**Variables 配置：**
```
SERVER_DIR: "/var/www/mysite"
KEEP_RELEASES: "5"
```

## 工作流程

1. **构建**: 项目会被构建一次并上传为 artifact
2. **并行部署**: 所有配置的服务器会并行接收部署
3. **原子切换**: 每个服务器上都会原子性地切换到新版本
4. **清理**: 自动清理旧版本，保留指定数量的历史版本
5. **结果汇总**: 显示每个服务器的部署结果，成功/失败统计

## 优势

- **配置简单**: 只需一套配置，无需为每个服务器单独设置
- **并行部署**: 多个服务器同时部署，提高效率
- **故障隔离**: 单个服务器部署失败不影响其他服务器
- **零停机**: 使用符号链接原子切换，确保零停机部署
- **版本管理**: 自动管理历史版本，支持快速回滚
- **详细日志**: 每个服务器的部署日志清晰标识，便于排查问题
- **结果汇总**: 部署完成后显示详细的成功/失败统计

## 注意事项

1. **一致性要求**: 所有服务器必须使用相同的用户名、端口和部署路径
2. **SSH配置**: 确保所有服务器的SSH配置正确，私钥可以访问所有服务器
3. **权限要求**: 部署目录路径必须在所有服务器上存在且有写权限
4. **网络要求**: GitHub Actions runner 需要能够访问所有配置的服务器
5. **主机验证**: 如果不配置 `KNOWN_HOSTS`，首次连接时会自动扫描主机密钥
