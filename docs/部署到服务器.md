## 服务器部署指南（GitHub Actions + SSH/rsync）

本仓库已在保留 GitHub Pages 部署的同时，新增“推送到自有服务器”的部署链路。构建产物来自 `dist/`，通过 SSH + rsync 上传至服务器路径 `/var/www/myjdml.top/blog` 并使用原子切换保留多版本，支持快速回滚。

---

### 一、前置信息
- **服务器地址**: `182.254.158.171`
- **目标目录**: `/var/www/myjdml.top/blog`
- **SSH 端口**: `22`（如不同请按实际端口）
- **构建产物目录**: `dist/`
- **部署脚本**: `scripts/deploy_server.sh`
- **工作流文件**: `.github/workflows/pages.yml`

---

### 二、GitHub Secrets/Variables 配置
在仓库 Settings → Secrets and variables → Actions 添加以下 Secrets；同时在仓库 Variables 中添加 `SERVER_DIR`：
- `SSH_PRIVATE_KEY`: 部署用户对应的私钥内容（PEM/OPENSSH 格式）
- `SERVER_HOST`: `182.254.158.171`
- `SERVER_PORT`: `22`
- `SERVER_USER`: 建议使用普通账号（如 `deploy`），可临时用 `root`
- 变量（Variables）`SERVER_DIR`: `/var/www/myjdml.top/blog`
- 可选 `KNOWN_HOSTS`: 服务器的 known_hosts 条目（如不设置，工作流会用 `ssh-keyscan` 自动加入）

---

### 三、服务器一次性准备
以下以 `deploy` 用户示例，使用 `root` 可省去部分授权步骤。

```bash
# 1) 创建部署用户
sudo useradd -m -s /bin/bash deploy || true

# 2) 配置 SSH 公钥（将与 SSH_PRIVATE_KEY 配对的公钥写入）
sudo -u deploy mkdir -p ~deploy/.ssh
sudo -u deploy chmod 700 ~deploy/.ssh
sudo -u deploy bash -lc 'echo "ssh-ed25519 AAAA...你的公钥" >> ~deploy/.ssh/authorized_keys'
sudo -u deploy chmod 600 ~deploy/.ssh/authorized_keys

# 3) 准备部署目录
sudo mkdir -p /var/www/myjdml.top/blog/{releases,shared}
sudo chown -R deploy:deploy /var/www/myjdml.top/blog

# 4) 安装 rsync
sudo apt-get update && sudo apt-get install -y rsync
```

如通过 Nginx 对外提供服务，推荐指向 `current` 符号链接（原子切换）：

- 独立站点根目录示例：
```nginx
server {
  listen 80;
  server_name myjdml.top;  # 或你的域名

  root /var/www/myjdml.top/blog/current;
  index index.html;
  location / { try_files $uri $uri/ =404; }
}
```

- 挂载在主站 `/blog` 路径：
```nginx
location /blog/ {
  alias /var/www/myjdml.top/blog/current/;
  try_files $uri $uri/ =404;
}
```

保存后验证并重载：
```bash
sudo nginx -t && sudo systemctl reload nginx
```

---

### 四、工作流说明（与本地目录对应）
工作流位于 `.github/workflows/pages.yml`，触发于 `master` 分支推送或手动执行。
流程：
1) `npm ci && npm run build` 产出 `dist/`
2) 保持原有 GitHub Pages 部署
3) 新增 `deploy_server` 任务，将构建产物上传到服务器

部署脚本 `scripts/deploy_server.sh` 会：
- 将 `dist/`（在 CI 中以 artifact 形式下载到 `site/`）上传到远端 `releases/release-<时间戳>-<sha>`
- 使用符号链接 `current` 原子切换到最新版本
- 清理旧版本，仅保留最近 5 个（可通过环境变量 `KEEP_RELEASES` 调整）

---

### 五、使用方法
- 推送到 `master` 分支，或在 GitHub Actions 手动运行 `Deploy site to GitHub Pages` 工作流
- 确保 Secrets 已配置正确，服务器 SSH 可连通

手动连通性自检：
```bash
ssh -p 22 deploy@182.254.158.171 "echo ok"
```

---

### 六、回滚指引
SSH 登录服务器后，将 `current` 指回旧版本：
```bash
ls -1dt /var/www/myjdml.top/blog/releases/release-* | sed -n '1,5p'
ln -sfn /var/www/myjdml.top/blog/releases/<要回滚的版本> /var/www/myjdml.top/blog/current
```

切换后无需重启服务（静态站点），如配置了缓存层可按需清理。

---

### 七、常见问题
- 权限错误：确认目标目录归属为部署用户（如 `deploy:deploy`），并且有写权限
- known_hosts 校验失败：在 Secrets 中设置 `KNOWN_HOSTS`，或等待工作流自动通过 `ssh-keyscan` 添加
- Nginx 404：确认 `root` 或 `alias` 指向了 `.../current`，且 `try_files` 设置正确

---

### 八、相关文件与路径
- `.github/workflows/pages.yml`：CI 工作流
- `scripts/deploy_server.sh`：原子部署脚本
- `dist/`：构建产物目录（由 `npm run build` 生成）
- 服务器 `/var/www/myjdml.top/blog/`：
  - `releases/`：历史版本目录
  - `current`：指向当前生效版本的符号链接


